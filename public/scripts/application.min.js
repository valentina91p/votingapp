
(function(){
	'use strict';
	angular.module('VotingApp', [
        'ngRoute',
        'ngMessages',
        'controllers',
        'services'
    ]).config(['$routeProvider', function($routeProvider){
    	$routeProvider.when('/',{
            templateUrl: './public/views/home.html'
        }).when('/login',{
    		templateUrl: './public/views/login.html',
            controller: 'LoginCtrl',
            controllerAs: 'ctrl'
    	}).when('/signup',{
            templateUrl: './public/views/signup.html',
            controller: 'SignUpCtrl',
            controllerAs: 'ctrl'
        }).when('/dashboard',{
    		templateUrl: './public/views/dashboard.html',
            controller: 'DashboardCtrl',
            controllerAs: 'ctrl'
    	}).otherwise({redirectTo:'/'});
    }])
    angular.module('controllers',[]);
    angular.module('services',[]);
    angular.module('directives',[]);
    angular.module('filters',[]);
})();

angular.module('controllers')
	.controller('DashboardCtrl', function(){});
angular.module('controllers')
	.controller('LoginCtrl', ['$scope','$session','$location', 
		function($scope, $session,$location){
			var self = this;
			self.credentials = {};
			self.rememberme = false;
			self.feedback = false;

			self.login = function(credentials, rememberme){
				var l = $session.login(credentials).then(function(resp){
					$session.setUser(resp.data.user);
					$location.url("/dashboard");
				},function(resp){
					self.feedback = resp.data.err;
				});
			};
			self.loginTwitter = function(){};
			self.loginFacebook = function(){};
		}]);
angular.module('controllers')
	.controller('SignUpCtrl', ['$session','$flash','$location',
	 function($session,$flash,$location){
		var self = this;
		self.user = {};
		self.feedback = false;
		self.signup = function(user){
			console.log(user);
			$session.register(user).then(function(resp){
				$flash.setInfo('Welcome to VotingApp. Now log in');
				$location.url('/login');
			},function(resp){
				self.feedback = resp.data.err;
			});
		};
	}]);
angular.module('services')
	.service('$flash', function(){
		var flash = {};
		var message = false;
		flash.retrieve = function(){
			if(!message)
				return false;
			var m = message;
			message = false;
			return m;
		};
		flash.hasFlash = function(){
			return message?true:false;
		}
		flash.setError = function(msg){
			message = {
				type:'ERROR',
				data:msg
			};
		};
		flash.setInfo = function(msg){
			message = {
				type:'INFO',
				data:msg
			};
		};flash.setWarning = function(msg){
			message = {
				type:'WARNING',
				data:msg
			};
		};flash.setSuccess = function(msg){
			message = {
				type:'SUCCESS',
				data:msg
			};
		};
		return flash;
	});
angular.module('services')
	.service('$session', ['$http',function($http){
		var session = {};
		var user = null;
		session.login = function(credentials){
			return $http.post('/login',credentials);
		}; 	
		session.setUser = function(u) {
			user = u;
		};
		session.logout = function(){
			return $http.post('/logout')
				.then(function(resp){
					user = null;
					return true;
				}).then(function(resp){
					return false;
				});
		};
		session.register = function(user){
			return $http.post('/register', user);
		};
		session.isLoggedIn = function(){
			return user !== null;
		};
		return session;
	}]);