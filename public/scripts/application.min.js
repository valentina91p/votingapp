
(function(){
	'use strict';
	angular.module('VotingApp', [
        'ngRoute',
        'ngMessages',
        'ngCookies',
        'controllers',
        'services'
    ]).config(['$routeProvider', function($routeProvider){
    	$routeProvider.when('/',{
            templateUrl: './public/views/home.html'
        }).when('/login',{
    		templateUrl: './public/views/login.html',
            controller: 'LoginCtrl',
            controllerAs: 'ctrl'
    	}).when('/signup',{
            templateUrl: './public/views/signup.html',
            controller: 'SignUpCtrl',
            controllerAs: 'ctrl'
        }).when('/dashboard',{
    		templateUrl: './public/views/dashboard.html',
            controller: 'DashboardCtrl',
            controllerAs: 'ctrl',
            access: { requiresLogin: true }
    	}).otherwise({redirectTo:'/'});
    }]).run(['$rootScope','$location','$session',
        function ($rootScope, $location, $session) {
            $rootScope.$on('$routeChangeStart', function (event, next) {
                if (next.access !== undefined) {
                    if(!$session.isLoggedIn()){
                        $location.path("/login");
                    }
                }
            });
        }]);
    angular.module('VotingApp').controller('MainCtrl', ['$session','$rootScope', '$location',
        function($session,$rootScope, $location){
            var self = this;
            self.current_user = $session.getUser();
            console.log(self.current_user);
            $rootScope.$on('login', function(event, args){
                console.log("On login");
                self.current_user = $session.getUser();
            });
            $rootScope.$on('logout', function(event,args){
                self.logout();
            });
            self.logout = function(){
                self.current_user = null;
                $session.logout();
                $location.url('/');
            };
        }]);
    angular.module('controllers',[]);
    angular.module('services',[]);
    angular.module('directives',[]);
    angular.module('filters',[]);
})();

angular.module('controllers')
	.controller('DashboardCtrl', function(){});
angular.module('controllers')
	.controller('LoginCtrl', ['$scope','$session','$location','$rootScope', 
		function($scope, $session,$location){
			var self = this;
			self.credentials = {};
			self.feedback = false;

			self.login = function(credentials){
				$session.login(credentials).then(function(resp){
					$location.url("/dashboard");
				},function(error){
					self.feedback = error;
				});
			};
			self.loginTwitter = function(){};
			self.loginFacebook = function(){};
		}]);
angular.module('controllers')
	.controller('SignUpCtrl', ['$session','$flash','$location',
	 function($session,$flash,$location){
		var self = this;
		self.user = {};
		self.feedback = false;
		self.signup = function(user){
			console.log(user);
			$session.register(user).then(function(resp){
				$flash.setInfo('Welcome to VotingApp. Now log in');
				$location.url('/login');
			},function(resp){
				self.feedback = resp.data.err;
			});
		};
	}]);
angular.module('services')
	.service('$flash', function(){
		var flash = {};
		var message = false;
		flash.retrieve = function(){
			if(!message)
				return false;
			var m = message;
			message = false;
			return m;
		};
		flash.hasFlash = function(){
			return message?true:false;
		}
		flash.setError = function(msg){
			message = {
				type:'ERROR',
				data:msg
			};
		};
		flash.setInfo = function(msg){
			message = {
				type:'INFO',
				data:msg
			};
		};flash.setWarning = function(msg){
			message = {
				type:'WARNING',
				data:msg
			};
		};flash.setSuccess = function(msg){
			message = {
				type:'SUCCESS',
				data:msg
			};
		};
		return flash;
	});
angular.module('services')
	.service('$session', ['$http','$cookies','$q','$rootScope',
		function($http,$cookies,$q, $rootScope){
		var session = {};
		var user = undefined;
		session.login = function(credentials){
			return $q(function(resolve, reject){
				$http.post('/login',credentials).then(function(resp){
					user = resp.data.user;
					$cookies.putObject('u',user);
					$rootScope.$emit('login');
					resolve(true);
				},function(resp){
					reject(resp.data.err);
				});
			});
		}; 	
		session.getUser = function(){
			if(!user)
				user = $cookies.getObject('u');
			return user;
		};
		session.logout = function(){
			return $http.post('/logout')
				.then(function(resp){
					user = undefined;
					$cookies.remove('u');
					return true;
				});
		};
		session.register = function(user){
			return $http.post('/register', user);
		};
		session.isLoggedIn = function(){
			return this.getUser() !== undefined;
		};
		return session;
	}]);